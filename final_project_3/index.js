async function initial() {
	console.log('載入模型...');
	document.getElementById('console').innerText = `載入模型...`
	this.net_tran = await tf.loadGraphModel('https://reiinakano.com/arbitrary-image-stylization-tfjs/saved_model_transformer_separable_js/model.json');
	console.log('Successfully loaded model');
	document.getElementById('console').innerText = `成功載入模型`
	
	this.webcamElement = document.getElementById('webcam');
	this.mode = false; //false:single
	this.brk = false;
	
	this.style7 = tf.tensor([[[[-0.10817161202430725, 0.23525398969650269, 0.030609969049692154, -0.15159094333648682, -0.2597895562648773, 0.32865074276924133, 0.18417388200759888, -0.26393771171569824, 0.33188363909721375, -0.1835915595293045, -0.1857491433620453, 0.1002005785703659, -0.5092850923538208, -0.4034649729728699, -0.40696534514427185, 0.06254632771015167, -0.28423094749450684, 0.2886493504047394, 0.13754747807979584, 0.2025459259748459, 0.13866885006427765, -0.2815406322479248, 0.2684013843536377, 0.8014233708381653, 0.5251813530921936, 0.03580697253346443, 0.1197585016489029, 0.11571136862039566, -0.09896478801965714, -0.2574446499347687, 0.018399996683001518, 0.17812663316726685, 0.10687334090471268, -0.009494779631495476, -0.2813287675380707, 0.015093868598341942, -0.1967204213142395, -0.021379899233579636, 0.6685562133789062, 0.511734127998352, 0.13898882269859314, -0.24220781028270721, -0.15217846632003784, -0.16816823184490204, -0.3203468322753906, 0.5633497834205627, 0.09209372848272324, 0.5427858233451843, -0.20902082324028015, 0.31892144680023193, 0.4315136671066284, -0.1301039606332779, -0.450391560792923, -0.21494334936141968, 0.2223900407552719, -0.0013028914108872414, 0.15270279347896576, 0.32170212268829346, 0.13630951941013336, -0.045122042298316956, 0.39978498220443726, -0.14192023873329163, 0.05001150444149971, -0.8142295479774475, 0.38967591524124146, -0.20960119366645813, -0.11917681992053986, -0.1937067210674286, -0.3578893542289734, -0.015127157792448997, 0.37872982025146484, -0.026689061895012856, 0.45193561911582947, -0.26776114106178284, 0.16134396195411682, -0.15818701684474945, -0.20496028661727905, 0.19173495471477509, -0.1410859227180481, 0.010255234315991402, 0.38206374645233154, -0.2469697743654251, 0.13168109953403473, -0.3128300607204437, 0.24666351079940796, 0.029497500509023666, 0.49366146326065063, 0.1585710048675537, -0.43035149574279785, 0.018779998645186424, 0.18114806711673737, 0.3696480095386505, -0.09191860258579254, 0.17884282767772675, 0.13204464316368103, -0.40273141860961914, -0.16350796818733215, 0.3877003490924835, 0.20595628023147583, -0.3861881196498871],]]]);
	this.style6 = tf.tensor([[[[-0.28094398975372314, 0.7808938026428223, 0.32810544967651367, 0.33149248361587524, -0.322788268327713, 0.6400595307350159, -0.022030193358659744, -0.18294815719127655, -0.2287159115076065, -0.13921470940113068, -0.19422917068004608, 0.1547921746969223, -0.11176016181707382, -0.5257517099380493, -0.12757983803749084, -0.07322897762060165, -0.7335720658302307, 0.16974064707756042, 0.5599105358123779, 0.24972742795944214, 0.4385252594947815, -0.5139199495315552, 0.695111870765686, 1.171546459197998, 0.7728398442268372, -0.12653286755084991, 0.5936048626899719, -0.1835256814956665, 0.2874443531036377, 0.2086072564125061, 0.05484957993030548, 0.6311790347099304, -0.5544747710227966, -0.16822044551372528, 0.07916659116744995, 0.19043585658073425, -0.3431074321269989, -0.6135814189910889, 0.8499180674552917, 0.46393394470214844, -0.194431871175766, -0.34200915694236755, 0.1692766547203064, -0.10012426972389221, -0.2613576352596283, 0.5901374220848083, -0.30208370089530945, -0.32708093523979187, 0.5553780198097229, -0.07601236552000046, 0.3908274173736572, 0.3305191397666931, -0.4311511218547821, -0.4451584815979004, 0.47988349199295044, 0.29094842076301575, 0.20750509202480316, 0.24134817719459534, 0.34202077984809875, -0.3350088894367218, 0.5250414609909058, -0.07938069105148315, 0.017927613109350204, -0.8910939693450928, 0.0033390596508979797, -0.32613763213157654, -0.19529645144939423, -0.6384943127632141, 0.206712543964386, -0.06252184510231018, 0.3632271885871887, -0.08706244081258774, 0.12560786306858063, -0.31503602862358093, -0.04289596900343895, -0.35391560196876526, 0.11775978654623032, 0.5158469676971436, -0.6602921485900879, -0.32266104221343994, 0.3249572813510895, -0.1481134444475174, 0.5023312568664551, -0.2795707881450653, 0.15078452229499817, -0.4427802264690399, 0.6288666129112244, 0.6334824562072754, -0.1036638468503952, 0.35244041681289673, 0.2112945169210434, 0.14013034105300903, 0.18148688971996307, 0.23408885300159454, 0.28530797362327576, -1.118350625038147, -0.018593281507492065, 0.7035728096961975, 0.8557436466217041, -0.22899912297725677],]]]);
	this.style5 = tf.tensor([[[[-0.3042018711566925, -0.1242174357175827, 0.07522298395633698, 0.13804779946804047, -0.4723409116268158, 0.6460710167884827, 0.2696656286716461, -0.4974265992641449, -0.02235790714621544, -0.668022871017456, -0.5129649043083191, 0.09703613817691803, -0.8636764287948608, -0.8386082649230957, -0.17530886828899384, 0.6428254842758179, -0.7699153423309326, 0.21014347672462463, 0.6971362233161926, 0.1558421105146408, 0.23048998415470123, -0.3641251027584076, 1.3297667503356934, 1.4844930171966553, 0.7413289546966553, -0.6563218235969543, 0.1534053534269333, 0.1993056982755661, 0.16719460487365723, 0.30716049671173096, -0.4897012412548065, 0.2916487753391266, -0.3017455041408539, -0.31021589040756226, -0.35315796732902527, 0.5557663440704346, -0.2293936163187027, -0.6228461861610413, 1.609981656074524, 0.4285755455493927, -0.13157396018505096, -0.37131428718566895, -0.15872400999069214, -0.29493576288223267, -0.5477111339569092, 0.613093376159668, 0.07587770372629166, 0.4965985417366028, -0.02478666789829731, 0.4096783697605133, 1.0320004224777222, 0.4146166145801544, -0.17827504873275757, -0.23307742178440094, -0.008131005801260471, 0.580514132976532, 0.04787110909819603, 0.5050480365753174, 0.6188960075378418, -0.3951316177845001, -0.21318089962005615, -0.33324968814849854, -0.5147046446800232, -0.5419978499412537, 0.4232631325721741, -0.4828208088874817, -0.4896073341369629, -0.4262005686759949, 0.017825894057750702, -0.15304531157016754, 0.13983111083507538, -0.535128116607666, 0.28618255257606506, -0.8233444094657898, -0.12379598617553711, -0.46497631072998047, 0.04337311536073685, 0.39926522970199585, -0.12294580042362213, 0.2690889239311218, 0.5323387384414673, -0.4878944754600525, 0.06442194432020187, 0.010592635720968246, 0.3569559156894684, -0.5729591846466064, 0.9646031856536865, 0.7746427059173584, -0.3987439274787903, 0.4029681384563446, -0.0009454647079110146, 0.4216109812259674, 0.0753791332244873, -0.3461814522743225, 0.6007802486419678, -0.9330223798751831, 0.13646520674228668, 0.12546643614768982, 0.7785486578941345, -0.242746964097023],]]]);
	this.style4 = tf.tensor([[[[-0.5720527172088623, 0.3756004273891449, 0.4600534737110138, -0.019201401621103287, -0.40169307589530945, 0.7441415190696716, 0.22545841336250305, -0.23860187828540802, -0.017244786024093628, -0.4194006025791168, -0.39985156059265137, 0.21629445254802704, -0.7274526953697205, -0.7970626354217529, -0.5254798531532288, 0.4088974893093109, -0.5041620135307312, 0.36020198464393616, 0.5585780739784241, 0.20526723563671112, 0.24027924239635468, -0.4764302372932434, 1.0701261758804321, 1.4478245973587036, 1.1320360898971558, -0.2512942850589752, 0.16396257281303406, 0.18545033037662506, 0.17125052213668823, 0.12608850002288818, 0.006010621320456266, 0.32914188504219055, -0.280875563621521, -0.3986125886440277, -0.48969125747680664, 0.2527845799922943, -0.24363408982753754, -0.4179137945175171, 1.4076905250549316, 0.809583842754364, 0.15617798268795013, -0.43964895606040955, 0.05073114484548569, -0.4991437792778015, -0.5720359086990356, 0.7817947864532471, -0.02257109433412552, 0.7503990530967712, 0.037095941603183746, 0.6326596736907959, 0.7199927568435669, 0.15666532516479492, -0.697247326374054, -0.15811869502067566, 0.2826530933380127, 0.4966844320297241, -0.15585900843143463, 0.6600803732872009, 0.12439089268445969, -0.6760590672492981, 0.25099489092826843, -0.6007662415504456, -0.21714730560779572, -1.3946807384490967, 0.28087174892425537, -0.38245436549186707, -0.5605841875076294, -0.6316711902618408, -0.501806914806366, -0.5333555936813354, 0.5374261140823364, -0.6061581373214722, 0.3381243348121643, -0.70769864320755, 0.11606932431459427, -0.5716403126716614, -0.2751782536506653, 0.6012518405914307, -0.292438805103302, 0.15223294496536255, 0.6898916959762573, -0.6392865180969238, 0.5376400351524353, -0.4344472885131836, 0.2875080406665802, -0.3436291217803955, 0.8132091164588928, 0.3387281000614166, -0.3493221700191498, 0.17131850123405457, 0.058416806161403656, 0.6513617038726807, -0.06311443448066711, 0.07696603238582611, 0.21686844527721405, -1.0813437700271606, -0.1316898614168167, 0.514358401298523, 0.6935539841651917, -0.9785192608833313],]]]);
	this.style3 = tf.tensor([[[[-0.02221580408513546, 0.26422280073165894, -0.20076221227645874, -0.10945381969213486, -0.47335919737815857, 0.5758776068687439, 0.1287032514810562, -0.7964723706245422, 0.2748379707336426, -0.5010724067687988, -0.7041470408439636, 0.387958824634552, -0.8964044451713562, -0.6129030585289001, -0.41591745615005493, 0.32179808616638184, -0.9217533469200134, 0.6560200452804565, 0.4431101083755493, 0.5449820756912231, 0.3217101991176605, -0.2545441687107086, 1.1326528787612915, 1.5679614543914795, 0.7732820510864258, -0.286144882440567, 0.3995724618434906, 0.07828550040721893, -0.009510661475360394, 0.5130301713943481, -0.43582114577293396, 0.4544660747051239, -0.30173996090888977, -0.2791881263256073, -0.33446577191352844, 0.3024936616420746, -0.23278889060020447, -0.6799519658088684, 1.4156782627105713, 0.6524733304977417, -0.22647394239902496, -0.43896663188934326, -0.1993565559387207, -0.22035464644432068, -0.8094508051872253, 0.6184918284416199, -0.013921859674155712, 0.6448336839675903, 0.008576088584959507, 0.18083465099334717, 1.0221506357192993, 0.46859508752822876, -0.6030601263046265, -0.6629304885864258, 0.5727035999298096, 0.2990782558917999, 0.34689220786094666, 0.5473902225494385, 0.4037787914276123, -0.08806589990854263, 0.2710696756839752, -0.3697551488876343, -0.13831372559070587, -1.0238280296325684, 0.46614497900009155, -0.4028255045413971, -0.34023845195770264, -0.2292783111333847, -0.47510281205177307, -0.014857208356261253, 0.5817678570747375, -0.3936830461025238, 0.5806893110275269, -0.7057487964630127, 0.1580188274383545, -0.4386734068393707, -0.22917430102825165, 0.21888697147369385, -0.23293867707252502, 0.2362861931324005, 0.29241615533828735, -0.5207913517951965, -0.17675919830799103, -0.37109801173210144, 0.3433105945587158, -0.3467477560043335, 0.7040790319442749, 0.7424069046974182, -0.2902204394340515, 0.5741854310035706, 0.1741805076599121, 0.6736827492713928, 0.3142510950565338, -0.17695197463035583, 0.7037817239761353, -1.0708088874816895, 0.05346199497580528, 0.7880911827087402, 0.6523909568786621, -0.18909476697444916],]]]);
	this.style2 = tf.tensor([[[[-0.21767154335975647, 0.5303010940551758, 0.005759250372648239, -0.3211158514022827, -0.5095604658126831, 0.7209118604660034, -0.010118294507265091, -0.6618266701698303, 0.11425785720348358, -0.3452221155166626, -0.5215857028961182, 0.42857563495635986, -0.7621447443962097, -0.6729413866996765, -0.6359776854515076, 0.20070135593414307, -0.48287251591682434, 0.6409544348716736, 0.4458085298538208, 0.4970778226852417, 0.2529159486293793, -0.38466715812683105, 0.9264565706253052, 1.3590184450149536, 1.0895193815231323, -0.09188473969697952, 0.2633555829524994, 0.12939774990081787, 0.1676018387079239, 0.14334453642368317, -0.011449581943452358, 0.3582996129989624, -0.1178780123591423, -0.37720316648483276, -0.5616155862808228, 0.14493097364902496, -0.20685099065303802, -0.5834687948226929, 1.1809087991714478, 1.0751980543136597, 0.2518361806869507, -0.510054349899292, -0.09391441196203232, -0.19848304986953735, -0.9516693949699402, 0.8612170219421387, -0.04265747219324112, 0.973022997379303, 0.013221163302659988, 0.44460371136665344, 0.7420966029167175, 0.038458891212940216, -0.8923587799072266, -0.36783233284950256, 0.4348924160003662, 0.4569018483161926, 0.10211288928985596, 0.5873099565505981, 0.15491607785224915, -0.2643454372882843, 0.5084547996520996, -0.4567641317844391, 0.12870784103870392, -1.3847143650054932, 0.39300066232681274, -0.24993380904197693, -0.6762914061546326, -0.46096062660217285, -0.8650109171867371, -0.37976375222206116, 0.8390259742736816, -0.5029569864273071, 0.47427433729171753, -0.5400270819664001, 0.3077065348625183, -0.30164405703544617, -0.6093842387199402, 0.3052961230278015, -0.18846382200717926, 0.20248949527740479, 0.47235435247421265, -0.5770729780197144, 0.12422014027833939, -0.4466216564178467, 0.22354060411453247, -0.16198711097240448, 0.7175858020782471, 0.34933435916900635, -0.4354706406593323, 0.3207252323627472, 0.3671511113643646, 0.7794551253318787, 0.21105550229549408, 0.08010223507881165, 0.30231067538261414, -1.057172417640686, -0.13313092291355133, 0.956008791923523, 0.6216816902160645, -0.567192018032074],]]]);
	this.style1 = tf.tensor([[[[-0.1547677367925644, 0.13444934785366058, 0.029615355655550957, -0.0911477580666542, 0.004116176627576351, 0.11420973390340805, 0.1317673921585083, -0.24624818563461304, 0.15121126174926758, -0.012971803545951843, -0.006335511337965727, -0.029306916519999504, -0.2826257050037384, -0.26007914543151855, -0.006314379163086414, -0.12663985788822174, -0.34846231341362, -0.01475090254098177, 0.027393098920583725, 0.06724845618009567, 0.01900816336274147, -0.30068692564964294, 0.37710505723953247, 0.4023718237876892, 0.37574830651283264, 0.03294399380683899, -0.003778357058763504, 0.008614743128418922, -0.18411791324615479, -0.17880170047283173, 0.097134530544281, 0.31795695424079895, 0.15974262356758118, 0.03234092518687248, -0.06847777962684631, 0.07132238149642944, -0.1775631457567215, -0.22833722829818726, 0.3449074327945709, 0.3403000235557556, 0.16145135462284088, -0.08566182851791382, -0.14581337571144104, -0.1551883965730667, -0.09075743705034256, 0.25210630893707275, -0.09898503124713898, 0.27317073941230774, 0.08971450477838516, 0.19968926906585693, 0.16714291274547577, -0.04482317715883255, -0.2281966209411621, -0.04796076565980911, 0.11921386420726776, -0.024841733276844025, 0.13077707588672638, 0.09706578403711319, 0.27924638986587524, 0.12293025106191635, 0.252595990896225, 0.27832338213920593, 0.017757976427674294, -0.3410106599330902, 0.19235298037528992, -0.12491320818662643, 0.07402162253856659, -0.0316801592707634, 0.04006796330213547, 0.09607900679111481, 0.2594453990459442, -0.0312705934047699, 0.18119344115257263, -0.021594803780317307, 0.18379433453083038, 0.009404923766851425, 0.0324581116437912, 0.298202246427536, -0.06535080075263977, -0.1299377977848053, 0.21672801673412323, -0.14909668266773224, -0.06398332118988037, -0.19179776310920715, 0.04872395098209381, -0.06116143986582756, 0.2681105136871338, 0.28497904539108276, -0.37386554479599, 0.004042584449052811, 0.2381274700164795, 0.015143243595957756, -0.21109876036643982, 0.15772484242916107, 0.13494175672531128, -0.1719697117805481, -0.004603997338563204, 0.23697370290756226, 0.426055371761322, -0.04473754018545151],]]]);
	
	this.style = document.getElementById('img_style');
	this.bottleneck = this.style1;
	
	this.bottleneck1=this.style1;
	this.bottleneck2=this.style2;
	
}

function BN()
{
	this.brk = true;
	document.getElementById("img_style").src="style/style" + document.getElementById("Style").value + ".jpg";
	
	if(document.getElementById("Style").value==1)		this.bottleneck1=this.style1;
	else if(document.getElementById("Style").value==2)	this.bottleneck1=this.style2;
	else if(document.getElementById("Style").value==3)	this.bottleneck1=this.style3;
	else if(document.getElementById("Style").value==4)	this.bottleneck1=this.style4;
	else if(document.getElementById("Style").value==5)	this.bottleneck1=this.style5;
	else if(document.getElementById("Style").value==6)	this.bottleneck1=this.style6;
	else if(document.getElementById("Style").value==7)	this.bottleneck1=this.style7;
	
	if(!$("input[name='onoffswitch']").prop("checked")){
		this.bottleneck = this.bottleneck1;
	}
	else mix_type();
}

function BN2()
{
	this.brk = true;
	document.getElementById("img_style2").src="style/style" + document.getElementById("Style2").value + ".jpg";
	
	if(document.getElementById("Style2").value==1)		this.bottleneck2=this.style1;
	else if(document.getElementById("Style2").value==2)	this.bottleneck2=this.style2;
	else if(document.getElementById("Style2").value==3)	this.bottleneck2=this.style3;
	else if(document.getElementById("Style2").value==4)	this.bottleneck2=this.style4;
	else if(document.getElementById("Style2").value==5)	this.bottleneck2=this.style5;
	else if(document.getElementById("Style2").value==6)	this.bottleneck2=this.style6;
	else if(document.getElementById("Style2").value==7)	this.bottleneck2=this.style7;
	
	mix_type();
}

function single()
{
	this.mode=false;
	document.getElementById('container2').style.display="block";
	document.getElementById('container3').style.display="none";
	document.getElementById('console2').innerText = ``
}
function cam()
{
	this.mode=true;
	document.getElementById('container2').style.display="none";
	document.getElementById('container3').style.display="block";
	document.getElementById('console3').innerText = ``
}

async function app() {
	document.getElementById('console2').innerText = `轉換中...`
	document.getElementById('console3').innerText = `轉換中...`
	if(!this.mode)
	{
		this.target = document.getElementById('img_target');
		const stylized = await tf.tidy(() => {
		  return this.net_tran.predict([tf.browser.fromPixels(this.target).toFloat().div(tf.scalar(255)).expandDims(), this.bottleneck]).squeeze();
		})
		document.getElementById('console2').innerText = `轉換完成!!!`
		await tf.browser.toPixels(stylized, this.stylized_single);
		stylized.dispose();
	}else
	{
		const webcam = await tf.data.webcam(webcamElement);
		this.brk = false;
		while (true) 
		{
			this.img = await webcam.capture();
			const stylized = await tf.tidy(() => {
			  return this.net_tran.predict([this.img.toFloat().div(tf.scalar(255)).expandDims(), this.bottleneck]).squeeze();
				})
			document.getElementById('console3').innerText = `轉換完成!!!`
			await tf.browser.toPixels(stylized, this.stylized_webcam);
			stylized.dispose();

			this.img.dispose();

			await tf.nextFrame();
			if (!this.mode) 
			{
				webcam.stop();
				break;
			}
			if (this.brk)
			{webcam.stop();
				break;
			}
		}
	}  
}

function mouse_in5(){
	const curFile = document.getElementById('input').files[0]; // 透過 input 取得的 file object
	const objectURL = URL.createObjectURL(curFile);
	//console.log(objectURL);

	//console.log(document.getElementById('input').files);
    document.getElementById("img_target").src=objectURL;
}

function Default()
{
    document.getElementById("img_target").src="https://liang-ting.github.io/image/IMG_0970.png";
	document.getElementById("input").value = "";
}

function mix_type(){
	const bn2 = tf.scalar(document.getElementById("myRange").value/100);
	const bn1 = tf.scalar(1-document.getElementById("myRange").value/100);
	this.bottleneck = tf.mul(this.bottleneck1, bn1).add(tf.mul(this.bottleneck2, bn2));
	//console.log(bn1+", "+bn2);
	//this.bottleneck.print();
}

initial();

$("input[name='onoffswitch']").click(function(){
	//console.log($("input[name='onoffswitch']").prop("checked"));
	if($("input[name='onoffswitch']").prop("checked")){
		$('#container').attr('id','container5');
		$('#sg').css('left', '370px');
		$('#wc').css('right', '370px');
		$('#img_style2').css('display', 'block');
		$('.slidecontainer').css('display', 'block');
		$('#Style2').css('display', 'block');
		$('#img_style2').css('opacity', '0.7');
		$('#img_style').css('opacity', '0.7');
		this.brk = true;
	}
	else{
		$('#container5').attr('id','container');
		$('#sg').css('left', '90px');
		$('#wc').css('right', '90px');
		$('#img_style2').css('display', 'none');
		$('.slidecontainer').css('display', 'none');
		$('#Style2').css('display', 'none');
		$('#img_style').css('opacity', '1');
		this.brk = true;
	}
});

/********slider********/
var slider = document.getElementById("myRange");
var output = document.getElementById("ratio");
output.innerHTML = (100-slider.value)+' / '+slider.value; // Display the default slider value

slider.oninput = function() {
	output.innerHTML = (100-this.value)+' / '+this.value;
	$('#img_style2').css('opacity', slider.value/100+0.2);
	$('#img_style').css('opacity', (100-slider.value)/100+0.2);
	mix_type();
}
/********slider********/
//app();
//console.log(this.bottleneck.arraySync()[0][0][0]);

/*
await tf.browser.fromPixels(this.style).print();
  document.getElementById("img_style").src="style/style" + document.getElementById("Style").value + ".jpg";
  this.style = await document.getElementById('img_style');
  console.log(this.style);
  tf.browser.fromPixels(this.style).print();
*/